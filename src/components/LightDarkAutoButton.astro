---
import IconSun from '~/icons/sun.svg'
import IconMoon from '~/icons/moon.svg'
import siteConfig from '~/site.config'
let lightTheme = siteConfig.themes.include[0]
let darkTheme = siteConfig.themes.include[1]
---

<button
  id="theme-change-button"
  class="block ml-auto"
  data-light={lightTheme}
  data-dark={darkTheme}
>
  <IconSun id="icon-light" class="hidden size-6 text-accent" />
  <IconMoon id="icon-dark" class="hidden size-6 text-accent" />
</button>

<script>
  const themeButton = document.getElementById('theme-change-button')
  const lightThemeId = themeButton?.getAttribute('data-light')
  const darkThemeId = themeButton?.getAttribute('data-dark')
  const sunIcon = themeButton?.querySelector('#icon-light')
  const moonIcon = themeButton?.querySelector('#icon-dark')

  const updateIcons = (theme: string) => {
    if (theme === lightThemeId) {
      sunIcon?.classList.remove('hidden')
      moonIcon?.classList.add('hidden')
    } else {
      sunIcon?.classList.add('hidden')
      moonIcon?.classList.remove('hidden')
    }
  }

  let currentTheme = localStorage.getItem('data-theme') || 'auto'
  if (currentTheme === 'auto') {
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)')
    currentTheme = prefersDarkScheme.matches
      ? darkThemeId || 'dark-plus'
      : lightThemeId || 'slack-ochin'
  }
  updateIcons(currentTheme)

  themeButton?.addEventListener('click', () => {
    const currentTheme = localStorage.getItem('data-theme') || 'auto'
    let actualCurrentTheme = currentTheme
    if (currentTheme === 'auto') {
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)')
      actualCurrentTheme = prefersDarkScheme.matches
        ? darkThemeId || 'dark-plus'
        : lightThemeId || 'slack-ochin'
    }

    const newTheme =
      actualCurrentTheme === (lightThemeId || 'slack-ochin')
        ? darkThemeId || 'dark-plus'
        : lightThemeId || 'slack-ochin'

    updateIcons(newTheme)
    localStorage.setItem('data-theme', newTheme)
    document.documentElement.setAttribute('data-theme', newTheme)
  })
</script>
